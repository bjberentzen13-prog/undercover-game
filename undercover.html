<!DOCTYPE html>
<html>
<head>
  <title>Undercover Multiplayer Game</title>
  <style>
    body { font-family: Arial; text-align: center; padding: 20px; }
    input, button { padding: 8px; margin: 5px; }
    #gameArea { display: none; }
    #descriptionArea, #votingArea { display: none; }
  </style>
</head>
<body>

<h1>ðŸŽ­ Undercover Game</h1>

<!-- CREATE ROOM -->
<div>
  <h2>Create Room</h2>
  <input id="playerName" placeholder="Your Name">
  <button id="createRoomBtn">Create Room</button>
  <p id="roomCodeDisplay"></p>
</div>

<!-- JOIN ROOM -->
<div>
  <h2>Join Room</h2>
  <input id="joinPlayerName" placeholder="Your Name">
  <input id="roomCode" placeholder="Room Code">
  <button id="joinRoomBtn">Join Room</button>
</div>

<!-- GAME AREA -->
<div id="gameArea">
  <h2>Room: <span id="gameRoomCode"></span></h2>
  <h3>Players:</h3>
  <ul id="playersList"></ul>

  <button id="startGameBtn" style="display:none;">START GAME</button>

  <div id="wordArea">
    <h3>Your Word:</h3>
    <p id="yourWord"></p>
  </div>

  <div id="descriptionArea">
    <h3>Your Turn to Describe:</h3>
    <textarea id="descriptionBox" placeholder="Describe your word..."></textarea><br>
    <button id="passBtn">Submit</button>
  </div>

  <div id="votingArea">
    <h3>Vote Who Is Undercover</h3>
    <ul id="voteList"></ul>
  </div>
</div>

<!-- ðŸ”¥ Firebase COMPAT Versions (must be compat for this code to work) -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

<script>
  // âœ… YOUR FIREBASE CONFIG (WORKING)
  const firebaseConfig = {
    apiKey: "AIzaSyCVDZpGOPsKTXlUWP5GoXJbdnNAWbHF0Hw",
    authDomain: "undercover-d0158.firebaseapp.com",
    projectId: "undercover-d0158",
    storageBucket: "undercover-d0158.firebasestorage.app",
    messagingSenderId: "984568915272",
    appId: "1:984568915272:web:0ee1eff6d7a6c71cdaff7d",
    measurementId: "G-5B6PVSHSSR"
  };

  // â›” MUST use compat version for this game to work
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let myUID = null;
  let currentRoom = null;

  firebase.auth().signInAnonymously().then(() => {
    myUID = firebase.auth().currentUser.uid;
  });

  // RANDOM WORDS
  const words = ["Apple", "Banana", "Car", "Dog", "Ocean", "Pizza", "Phone", "Moon", "Candle", "Game"];

  // CREATE ROOM
  document.getElementById("createRoomBtn").addEventListener("click", () => {
    const name = document.getElementById("playerName").value.trim();
    if (!name) return alert("Enter your name!");

    const roomCode = Math.floor(1000 + Math.random() * 9000).toString();
    currentRoom = roomCode;

    db.ref("rooms/" + roomCode).set({
      host: myUID,
      phase: "lobby",
      words: {},
      players: {}
    });

    db.ref("rooms/" + roomCode + "/players/" + myUID).set({ name });

    document.getElementById("roomCodeDisplay").innerText = "Room: " + roomCode;
    enterGame(roomCode);
  });

  // JOIN ROOM
  document.getElementById("joinRoomBtn").addEventListener("click", () => {
    const name = document.getElementById("joinPlayerName").value.trim();
    const roomCode = document.getElementById("roomCode").value.trim();

    if (!name || !roomCode) return alert("Enter name & room code!");

    currentRoom = roomCode;
    db.ref("rooms/" + roomCode + "/players/" + myUID).set({ name });
    enterGame(roomCode);
  });

  // ENTER GAME
  function enterGame(roomCode) {
    document.getElementById("gameArea").style.display = "block";
    document.getElementById("gameRoomCode").innerText = roomCode;

    db.ref("rooms/" + roomCode + "/players").on("value", snap => {
      const list = document.getElementById("playersList");
      list.innerHTML = "";

      const players = snap.val() || {};
      Object.keys(players).forEach(uid => {
        const li = document.createElement("li");
        li.textContent = players[uid].name;
        list.appendChild(li);
      });

      db.ref("rooms/" + roomCode).once("value").then(data => {
        if (data.val().host === myUID) {
          document.getElementById("startGameBtn").style.display = "block";
        }
      });
    });
  }

  // START GAME
  document.getElementById("startGameBtn").addEventListener("click", () => {
    const randomWord = words[Math.floor(Math.random() * words.length)];

    db.ref("rooms/" + currentRoom + "/players").once("value").then(snap => {
      const players = snap.val();
      const uids = Object.keys(players);
      const undercoverIndex = Math.floor(Math.random() * uids.length);
      const undercoverUID = uids[undercoverIndex];

      uids.forEach(uid => {
        db.ref("rooms/" + currentRoom + "/words/" + uid).set(
          uid === undercoverUID ? "" : randomWord
        );
      });

      db.ref("rooms/" + currentRoom).update({ phase: "describe" });
    });
  });

  // SHOW WORD
  db.ref("rooms").on("value", snap => {
    if (!currentRoom) return;

    const room = snap.val()[currentRoom];
    if (room && room.phase === "describe") {
      document.getElementById("descriptionArea").style.display = "block";

      db.ref("rooms/" + currentRoom + "/words/" + myUID)
        .once("value")
        .then(wordSnap => {
          document.getElementById("yourWord").innerText = wordSnap.val() || "â“ YOU are the Undercover!";
        });
    }
  });

  // SUBMIT DESCRIPTION
  document.getElementById("passBtn").addEventListener("click", () => {
    const desc = document.getElementById("descriptionBox").value.trim();
    db.ref(`rooms/${currentRoom}/descriptions/${myUID}`).set(desc);
    document.getElementById("descriptionBox").disabled = true;
    document.getElementById("passBtn").disabled = true;

    // Move to voting when everyone is done
    db.ref(`rooms/${currentRoom}/players`).once("value").then(snap => {
      const total = Object.keys(snap.val()).length;

      db.ref(`rooms/${currentRoom}/descriptions`).once("value").then(descSnap => {
        if (Object.keys(descSnap.val()).length === total) {
          db.ref(`rooms/${currentRoom}`).update({ phase: "voting" });
        }
      });
    });
  });

  // VOTING
  db.ref("rooms").on("value", snap => {
    if (!currentRoom) return;

    const room = snap.val()[currentRoom];
    if (room && room.phase === "voting") {
      document.getElementById("votingArea").style.display = "block";

      const voteList = document.getElementById("voteList");
      voteList.innerHTML = "";

      db.ref(`rooms/${currentRoom}/players`).once("value").then(snap => {
        const players = snap.val();

        Object.keys(players).forEach(uid => {
          if (uid === myUID) return;
          const li = document.createElement("li");
          li.innerHTML = `${players[uid].name} <button onclick="castVote('${uid}')">Vote</button>`;
          voteList.appendChild(li);
        });
      });
    }
  });

  function castVote(votedUid) {
    db.ref(`rooms/${currentRoom}/votes/${myUID}`).set(votedUid);
    alert("Vote Submitted!");
  }
</script>

</body>
</html>
